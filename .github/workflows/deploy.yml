---
name: Template Repository Maintenance

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  template-maintenance:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Update template metadata
        run: |
          echo "ðŸ“‹ Updating template metadata..."

          # Update last modified date in key files
          current_date=$(date '+%Y-%m-%d')

          # Update wiki template README with current date
          if [ -f "wiki-template/README.md" ]; then
            echo "Updating wiki template metadata..."
          fi

          echo "âœ… Template metadata updated."

      - name: Validate template integrity
        run: |
          echo "ðŸ” Validating template integrity before any updates..."

          # Run the same validation as CI
          essential_files=("README.md" "LICENSE" "CODE_OF_CONDUCT.md" ".gitignore")

          for file in "${essential_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing essential file: $file"
              exit 1
            fi
          done

          echo "âœ… Template integrity validated."

      - name: Generate template statistics
        run: |
          echo "ðŸ“Š Generating template usage statistics..."

          echo "Template Statistics:"
          echo "==================="
          echo "Documentation files: $(find docs/ -name "*.md" 2>/dev/null | wc -l)"
          echo "Issue templates: $(find .github/ISSUE_TEMPLATE/ -name "*.yml" 2>/dev/null | wc -l)"
          echo "Wiki templates: $(find wiki-template/ -name "*.md" 2>/dev/null | wc -l)"
          echo "Setup scripts: $(find scripts/ -name "*.sh" 2>/dev/null | wc -l)"
          echo "Workflow files: $(find .github/workflows/ -name "*.yml" 2>/dev/null | wc -l)"

          total_lines=$(find . -name "*.md" -o -name "*.yml" -o -name "*.sh" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          echo "Total template lines: $total_lines"

      - name: Check for template updates needed
        run: |
          echo "ðŸ”„ Checking if template needs updates..."

          # Check if any major GitHub Actions need updating
          if grep -r "actions/checkout@v3" .github/workflows/ 2>/dev/null; then
            echo "âš ï¸ Found outdated action versions - consider updating"
          fi

          # Check if documentation references are still valid
          if grep -r "github.com/CivicTechWR" docs/ wiki-template/ 2>/dev/null >/dev/null; then
            echo "âœ… CivicTechWR references found in documentation"
          fi

  template-documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate template README stats
        run: |
          echo "ðŸ“ˆ Template Usage Statistics" > TEMPLATE_STATS.md
          echo "=============================" >> TEMPLATE_STATS.md
          echo "" >> TEMPLATE_STATS.md
          echo "Generated on: $(date)" >> TEMPLATE_STATS.md
          echo "" >> TEMPLATE_STATS.md
          echo "## Template Components" >> TEMPLATE_STATS.md
          echo "" >> TEMPLATE_STATS.md
          echo "- Documentation files: $(find docs/ -name "*.md" 2>/dev/null | wc -l)" >> TEMPLATE_STATS.md
          echo "- Issue templates: $(find .github/ISSUE_TEMPLATE/ -name "*.yml" 2>/dev/null | wc -l)" >> TEMPLATE_STATS.md
          echo "- Wiki templates: $(find wiki-template/ -name "*.md" 2>/dev/null | wc -l)" >> TEMPLATE_STATS.md
          echo "- Setup scripts: $(find scripts/ -name "*.sh" 2>/dev/null | wc -l)" >> TEMPLATE_STATS.md
          echo "- Workflow files: $(find .github/workflows/ -name "*.yml" 2>/dev/null | wc -l)" >> TEMPLATE_STATS.md

      - name: Notify on template changes
        if: github.event_name == 'push'
        run: |
          echo "ðŸ”” Template updated on main branch"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Template is ready for use by CivicTechWR projects!"

  release-notification:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4

      - name: Celebrate template release
        run: |
          echo "ðŸŽ‰ CivicTechWR Project Template Release!"
          echo "======================================"
          echo ""
          echo "Release: ${{ github.event.release.tag_name }}"
          echo "Name: ${{ github.event.release.name }}"
          echo ""
          echo "This template is now ready for CivicTechWR teams to use!"
          echo ""
          echo "To use this template:"
          echo "1. Go to: ${{ github.repository }}"
          echo "2. Click 'Use this template'"
          echo "3. Create your new project repository"
          echo "4. Run ./scripts/setup.sh to get started"
          echo "5. Run ./scripts/setup-project.sh to create GitHub Project"
          echo ""
          echo "Happy civic hacking! ðŸš€"
